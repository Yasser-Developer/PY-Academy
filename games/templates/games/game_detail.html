{% extends 'base.html' %}

{% block title %}{{ game.title }} - PY-Academy{% endblock %}

{% block content %}
    <!-- CSRF token Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØ°Ø§Ø±ÛŒÙ… ØªØ§ JavaScript Ø¨ØªÙˆÙ†Ù‡ Ø§Ø²Ø´ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ù‡ -->
    {% csrf_token %}

    <div class="max-w-5xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
        <!-- Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª -->
        <a href="{% url 'game_list' %}" class="text-indigo-400 hover:text-indigo-300 mb-6 inline-block text-lg font-medium">
            â† Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§
        </a>

        <h1 class="text-4xl md:text-5xl font-bold text-white mb-8 text-center">
            {{ game.title }}
        </h1>

        <p class="text-xl text-gray-300 mb-10 text-center">
            {{ game.description }}
        </p>

        {% if game.instructions %}
            <div class="bg-gray-900/70 backdrop-blur-xl p-8 rounded-3xl border border-indigo-700/30 shadow-2xl mb-8">
                <h2 class="text-2xl font-bold text-indigo-300 mb-3">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¨Ø§Ø²ÛŒ</h2>
                <div class="text-gray-300 leading-relaxed">
                    {{ game.instructions|linebreaks }}
                </div>
                {% if game.hints %}
                    <div class="mt-6 bg-black/30 border border-gray-800 rounded-2xl p-5">
                        <div class="text-yellow-300 font-bold mb-2">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ</div>
                        <div class="text-gray-200">{{ game.hints|linebreaks }}</div>
                    </div>
                {% endif %}
            </div>
        {% endif %}

        <div class="bg-gray-900/70 backdrop-blur-xl p-8 rounded-3xl border border-gray-700 shadow-2xl">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                <h2 class="text-3xl font-bold text-blue-400">
                    Ú©Ø¯ Ø±Ùˆ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡ Ùˆ Ø­Ù„Ø´ Ú©Ù†
                </h2>
                <div class="text-sm text-gray-300 bg-black/30 border border-gray-800 rounded-2xl px-4 py-2">
                    Ø³Ø®ØªÛŒ: {{ game.difficulty }} / 5
                </div>
            </div>

            <!-- Ø§Ø¯ÛŒØªÙˆØ± Ú©Ø¯ -->
            <textarea id="codeEditor" class="w-full h-64 p-4 bg-gray-800 border border-gray-700 text-white font-mono text-sm rounded-lg resize-y">
{{ game.code_template|default:"print('Ø³Ù„Ø§Ù…! Ú©Ø¯ Ø®ÙˆØ¯Øª Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³')" }}
            </textarea>

            <div class="mt-6 text-center">
                <button onclick="runCode()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-12 rounded-full text-xl shadow-2xl transform hover:scale-105 transition-all duration-300">
                    Ø±Ø§Ù† Ú©Ù† Ùˆ Ù†ØªÛŒØ¬Ù‡ Ø±Ùˆ Ø¨Ø¨ÛŒÙ†
                </button>
            </div>

            <!-- Ø®Ø±ÙˆØ¬ÛŒ -->
            <div id="output" class="mt-8 p-8 bg-black rounded-3xl border border-gray-700 min-h-[200px] text-white font-mono whitespace-pre-wrap">
                Ù†ØªÛŒØ¬Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´Ù‡...
            </div>
        </div>

        <p class="text-center text-indigo-400 mt-8 text-xl font-bold">
            Ø¬Ø§ÛŒØ²Ù‡ Ø§ÛŒÙ† Ø¨Ø§Ø²ÛŒ: {{ game.xp_reward }} XP
        </p>
    </div>

    <!-- Ø§Ø³Ú©Ø±ÛŒÙ¾Øª AJAX Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù† Ú©Ø¯ -->
    <script>
        function runCode() {
            const code = document.getElementById('codeEditor').value;
            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù† Ú©Ø±Ø¯Ù† Ú©Ø¯...';

            // CSRF token Ø±Ùˆ Ø§Ø² input Ù…Ø®ÙÛŒ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch("{% url 'run_game_code' game.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken  // Ø§ÛŒÙ† Ù…Ù‡Ù…Ù‡!
                },
                body: 'code=' + encodeURIComponent(code)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = '<pre>' + data.output + '</pre>';
                    if (data.xp_awarded) {
                        html += '<p class="text-green-400 mt-4">Ú©Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±Ø§Ù† Ø´Ø¯! +' + data.xp_amount + ' XP Ú¯Ø±ÙØªÛŒ ğŸ‰</p>';
                    } else {
                        html += '<p class="text-green-400 mt-4">Ú©Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±Ø§Ù† Ø´Ø¯!</p>';
                    }
                    outputDiv.innerHTML = html;
                } else {
                    let html = '<pre class="text-red-300">' + data.output + '</pre>' +
                        '<p class="text-red-300 mt-4 font-bold">Ù‡Ù†ÙˆØ² Ø­Ù„ Ù†Ø´Ø¯Ù‡. Ø®Ø±ÙˆØ¬ÛŒ Ø±Ùˆ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù…Ø«Ù„ Ù†Ù…ÙˆÙ†Ù‡ Ø¯Ø±Ø³Øª Ú©Ù†.</p>';
                    if (data.expected_output) {
                        html += '<div class="mt-6 bg-gray-950 border border-gray-800 rounded-2xl p-5">' +
                            '<div class="text-gray-300 font-bold mb-2">Ø®Ø±ÙˆØ¬ÛŒ Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø±:</div>' +
                            '<pre class="text-green-300 whitespace-pre-wrap">' + data.expected_output + '</pre>' +
                            '</div>';
                    }
                    outputDiv.innerHTML = html;
                }
            })
            .catch(error => {
                outputDiv.innerHTML = '<p class="text-red-400">Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ' + error + '</p>';
            });
        }
    </script>
{% endblock %}