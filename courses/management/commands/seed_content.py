from __future__ import annotations

from django.core.management.base import BaseCommand
from django.db import transaction
from django.utils import timezone

from accounts.models import CustomUser
from blog.models import Post
from courses.models import Course, Lesson
from games.models import GameChallenge
from videos.models import EducationalVideo


class Command(BaseCommand):
    help = "Create starter content (courses/lessons/games/videos/blog posts). Safe to run multiple times."

    @transaction.atomic
    def handle(self, *args, **options):
        now = timezone.now()

        # Ensure at least one staff author for blog posts (optional)
        author = CustomUser.objects.filter(is_staff=True).order_by("id").first()

        courses_pack = [
            {
                "title": "پایتون مقدماتی (از صفر تا اولین پروژه‌ها)",
                "description": (
                    "این دوره برای شروع از صفره: قدم‌های کوتاه، مثال‌های ساده، چالش‌های قابل حل و چند بازی کدینگ.\n"
                    "هدف: مفاهیم پایه رو یاد بگیری و بتونی برنامه‌های کوچک بسازی."
                ),
                "xp_reward": 400,
                "lessons": [
                    ("شروع کار با print", "چاپ کردن متن و اعداد", "۳ خط مختلف چاپ کن.", 40),
                    ("متغیرها", "نگه‌داری داده داخل متغیر", "نام و سن رو توی متغیر بذار و چاپ کن.", 50),
                    ("محاسبات", "جمع/تفریق/ضرب/تقسیم", "جمع ۲ عدد رو چاپ کن.", 50),
                    ("رشته‌ها", "ساخت پیام با متن‌ها", "یک پیام خوشامد بساز.", 50),
                    ("if ساده", "تصمیم‌گیری در برنامه", "اگر عدد مثبت بود پیام بده.", 60),
                    ("حلقه for", "تکرار کارها", "از ۱ تا ۱۰ چاپ کن.", 70),
                    ("لیست", "چند مقدار کنار هم", "۳ میوه رو توی لیست بذار و چاپ کن.", 80),
                    ("کار با len", "طول لیست/متن", "طول یک لیست رو چاپ کن.", 60),
                    ("حلقه و لیست", "چرخیدن روی لیست", "همه آیتم‌های لیست رو یکی‌یکی چاپ کن.", 80),
                    ("مینی‌پروژه: کارت معرفی", "چند خط خروجی مرتب", "یک کارت معرفی متنی چاپ کن.", 90),
                    ("مینی‌پروژه: جدول ضرب", "حلقه‌های ساده", "جدول ضرب ۲ رو چاپ کن.", 100),
                    ("جمع‌بندی و مسیر بعدی", "چی یاد گرفتیم؟", "۳ تمرین کوچیک انجام بده.", 60),
                ],
            },
            {
                "title": "پایتون پیشرفته (مهارت واقعی برای حل مسئله)",
                "description": (
                    "این دوره برای زمانی است که با مبانی راحت شدی. تمرکز روی فکر کردن مثل برنامه‌نویس است.\n"
                    "هدف: حل مسئله، ساخت کد تمیز و آماده شدن برای پروژه‌های واقعی."
                ),
                "xp_reward": 600,
                "lessons": [
                    ("تابع‌ها", "تقسیم برنامه به بخش‌های کوچک", "یک تابع بساز که سلام کنه.", 90),
                    ("لیست پیشرفته", "جمع/میانگین/بیشینه", "بیشترین عدد یک لیست رو پیدا کن.", 100),
                    ("دیکشنری", "کلید/مقدار", "امتیاز دانش‌آموزها رو نگه دار.", 110),
                    ("حلقه‌های ترکیبی", "for + if", "فقط عددهای زوج رو چاپ کن.", 90),
                    ("توابع کاربردی", "min/max/sum", "میانگین چند عدد رو حساب کن.", 100),
                    ("الگوهای چاپی", "ساخت شکل با حلقه", "یک مثلث ستاره‌ای چاپ کن.", 110),
                    ("رفع باگ", "خواندن خطا و اصلاح", "کد خراب رو درست کن.", 120),
                    ("زمان و تمرین", "تمرین هدفمند", "۳ تمرین کوتاه حل کن.", 80),
                    ("پروژه: امتیازدهی", "لیست + شرط", "XP یک بازی رو محاسبه کن.", 140),
                    ("پروژه: دفترچه کارها", "لیست + منطق", "یک لیست کارها بساز و چاپ کن.", 140),
                    ("پروژه: گزارش ساده", "دیکشنری + حلقه", "گزارش امتیازها رو چاپ کن.", 150),
                    ("جمع‌بندی پیشرفته", "نقشه ادامه", "مسیر بعدی رو انتخاب کن.", 80),
                ],
            },
            {
                "title": "آموزش Django (ساخت سایت واقعی با پایتون)",
                "description": (
                    "در این دوره یاد می‌گیری با Django یک وب‌سایت واقعی بسازی: مدل، ویو، URL، تمپلیت و ادمین.\n"
                    "هدف: از پایتون به محصول واقعی برسی."
                ),
                "xp_reward": 700,
                "lessons": [
                    ("Django چیه؟", "معرفی MVC/MVT و ساخت پروژه", "یک پروژه Django بساز.", 80),
                    ("اپ و URL", "ساخت app و مسیرها", "یک صفحه ساده بساز.", 90),
                    ("تمپلیت‌ها", "HTML + extends", "یک base و یک صفحه بساز.", 90),
                    ("مدل‌ها", "ساخت جدول‌ها", "یک مدل ساده بساز.", 110),
                    ("ادمین", "مدیریت محتوا", "مدل رو توی admin ثبت کن.", 100),
                    ("ORM", "کوئری گرفتن", "لیست آیتم‌ها رو نمایش بده.", 110),
                    ("فرم‌ها", "دریافت ورودی", "یک فرم ساده بساز.", 110),
                    ("آپلود فایل", "media و فایل", "آپلود تصویر رو فعال کن.", 120),
                    ("Auth", "ثبت‌نام/ورود", "صفحه ورود رو بساز.", 120),
                    ("پروژه: بلاگ کوچک", "پست و جزئیات", "لیست و جزئیات پست‌ها.", 150),
                    ("پروژه: لیدربورد", "رتبه‌بندی", "۱۰ نفر برتر رو نشون بده.", 120),
                    ("جمع‌بندی", "چک‌لیست آماده‌سازی", "آماده توسعه بیشتر شو.", 80),
                ],
            },
        ]

        for course_idx, c in enumerate(courses_pack, start=1):
            course, _ = Course.objects.get_or_create(
                title=c["title"],
                defaults={
                    "description": c["description"],
                    "xp_reward": c["xp_reward"],
                    "is_active": True,
                },
            )

            for idx, (title, content, challenge, xp) in enumerate(c["lessons"], start=1):
                Lesson.objects.get_or_create(
                    course=course,
                    title=title,
                    defaults={
                        "content": f"{content}\n\nتمرین:\n{challenge}\n",
                        "challenge": challenge,
                        "xp_reward": xp,
                        "order": idx,
                        "is_active": True,
                    },
                )

        games_data = [
            {
                "title": "بازی ۱: چاپ جادویی",
                "description": "با print خروجی دقیق بساز و XP بگیر.",
                "instructions": "هدف: خروجی دقیق زیر رو بساز.\nقانون: فقط جای ??? رو تغییر بده.",
                "code_template": "print('???')\n",
                "expected_output": "سلام پایتون!\n",
                "hints": "داخل کوتیشن‌ها متن رو درست بنویس.",
                "xp_reward": 40,
                "difficulty": 1,
            },
            {
                "title": "بازی ۲: کارت معرفی",
                "description": "با متغیرها یک کارت معرفی خوشگل چاپ کن.",
                "instructions": "هدف: دقیقاً این خروجی رو بساز:\nنام: علی\nسن: 12\n\nقانون: مقدار متغیرها رو درست کن.",
                "code_template": "name = '???'\nage = ???\nprint('نام:', name)\nprint('سن:', age)\n",
                "expected_output": "نام: علی\nسن: 12\n",
                "hints": "سن باید عدد باشه. نام داخل کوتیشن.",
                "xp_reward": 60,
                "difficulty": 1,
            },
            {
                "title": "بازی ۳: ماشین‌حساب کوچک",
                "description": "عملیات جمع رو درست انجام بده و خروجی دقیق بساز.",
                "instructions": "هدف: خروجی باید دقیقاً عدد 17 باشه.\nقانون: فقط عددها رو تغییر بده.",
                "code_template": "a = 10\nb = 5\nprint(a + b)\n",
                "expected_output": "17\n",
                "hints": "a و b رو طوری بگذار که جمع‌شون 17 بشه.",
                "xp_reward": 70,
                "difficulty": 2,
            },
            {
                "title": "بازی ۴: فقط زوج‌ها",
                "description": "با حلقه و شرط، فقط عددهای زوج رو چاپ کن.",
                "instructions": "هدف: از 1 تا 10 فقط زوج‌ها چاپ بشن، هر کدوم در یک خط.",
                "code_template": "for i in range(1, 11):\n    # TODO: فقط زوج‌ها رو چاپ کن\n    pass\n",
                "expected_output": "2\n4\n6\n8\n10\n",
                "hints": "اگر i % 2 == 0 بود print کن.",
                "xp_reward": 120,
                "difficulty": 3,
            },
            {
                "title": "بازی ۵: جمع لیست",
                "description": "با حلقه، مجموع لیست رو حساب کن.",
                "instructions": "هدف: مجموع لیست [3, 4, 5] باید چاپ بشه.",
                "code_template": "nums = [3, 4, 5]\n# TODO: مجموع رو حساب کن و چاپ کن\n",
                "expected_output": "12\n",
                "hints": "یک متغیر sum = 0 بساز و توی حلقه جمع کن.",
                "xp_reward": 150,
                "difficulty": 3,
            },
        ]
        for g in games_data:
            GameChallenge.objects.update_or_create(
                title=g["title"],
                defaults={
                    "description": g["description"],
                    "instructions": g["instructions"],
                    "code_template": g["code_template"],
                    "expected_output": g["expected_output"],
                    "hints": g["hints"],
                    "xp_reward": g["xp_reward"],
                    "difficulty": g["difficulty"],
                    "is_active": True,
                },
            )

        videos_data = [
            (
                "شروع سریع پایتون برای بچه‌ها",
                "در ۵ دقیقه با print، متغیر و تمرین ساده آشنا شو.",
                "https://www.youtube.com/embed/kqtD5dpn9C8",
                20,
            ),
            (
                "if در پایتون (خیلی ساده)",
                "با شرط‌ها یاد می‌گیری برنامه تصمیم بگیره.",
                "https://www.youtube.com/embed/2C6xO4b7W9o",
                20,
            ),
        ]
        for title, desc, youtube_url, xp in videos_data:
            EducationalVideo.objects.get_or_create(
                title=title,
                defaults={
                    "description": desc,
                    "youtube_url": youtube_url,
                    "xp_reward": xp,
                    "min_watch_seconds": 30,
                },
            )

        posts_data = [
            ("چرا پایتون برای بچه‌ها عالیه؟", "پایتون ساده، جذاب و مناسب شروع برنامه‌نویسی برای دانش‌آموزهاست.", "پایتون به خاطر ساده بودن و خوانایی، برای شروع برنامه‌نویسی عالیه.\n\nاگر هر روز فقط ۱۵ دقیقه تمرین کنی، خیلی سریع می‌تونی پروژه‌های ساده بسازی.\n\nپیشنهاد: مسیر یادگیری رو دنبال کن و بعد از هر درس یک بازی انجام بده.", "python-for-kids"),
            ("نقشه راه یادگیری پایتون در ۳۰ روز", "یک برنامه ساده روزانه برای اینکه از صفر به مهارت واقعی برسی.", "اگر تازه شروع کردی، مهم‌ترین چیز «پیوستگی»ه.\n\nبرنامه پیشنهادی:\n- هفته ۱: print، متغیر، عددها\n- هفته ۲: شرط‌ها و حلقه‌ها\n- هفته ۳: لیست و تمرین ترکیبی\n- هفته ۴: پروژه‌های کوچک\n\nهر روز ۱۵ تا ۳۰ دقیقه کافی است.", "python-30-days"),
            ("چطور فرزندم رو به کدنویسی علاقه‌مند کنم؟", "با بازی، پروژه‌های کوچک و تشویق درست، کدنویسی می‌تونه سرگرم‌کننده بشه.", "بهترین راه علاقه‌مند کردن بچه‌ها به کدنویسی اینه که یادگیری رو شبیه بازی کنید.\n\nقانون طلایی: نتیجه سریع + تشویق درست.\n\nبه جای فشار، یک هدف کوچک روزانه بگذارید.", "motivate-kids-coding"),
            ("۵ اشتباه رایج در شروع برنامه‌نویسی", "این اشتباه‌ها باعث می‌شن زود خسته بشی. جلوگیری کن.", "۱) درس خیلی طولانی\n۲) تمرین نکردن\n۳) ترس از خطا\n۴) مقایسه با دیگران\n۵) برنامه نداشتن\n\nراه حل: درس کوتاه، تمرین روزانه، بازی کدینگ.", "common-mistakes"),
            ("XP و سطح یعنی چی؟", "چطور از XP برای انگیزه و پیشرفت استفاده کنی.", "XP یک روش ساده برای دیدن پیشرفت است.\n\nهر بار درس یا بازی رو کامل می‌کنی XP می‌گیری، سطح بالا می‌ره و انگیزه‌ات بیشتر می‌شه.\n\nتمرکز باید روی یادگیری باشد، XP فقط ابزار انگیزه است.", "xp-and-level"),
            ("چطور با خطاها دوست بشیم؟", "ارور دشمن نیست؛ راهنماست.", "هر ارور یک پیام دارد: «کجا مشکل است؟»\n\nسه قدم:\n۱) متن ارور را بخوان\n۲) خط مشکل‌دار را پیدا کن\n۳) یک تغییر کوچک بده و دوباره تست کن\n\nبا تمرین، سرعتت چند برابر می‌شه.", "errors-are-friends"),
            ("تمرین‌های کوتاه برای تقویت حلقه‌ها", "چند تمرین ساده ولی خیلی مفید.", "تمرین ۱: از ۱ تا ۲۰ چاپ کن.\nتمرین ۲: فقط زوج‌ها رو چاپ کن.\nتمرین ۳: مجموع ۱ تا ۱۰ رو حساب کن.\n\nبعد از هر تمرین خروجی رو دقیق بررسی کن.", "loop-practice"),
            ("تمرین‌های کوتاه برای if", "برای اینکه شرط‌ها رو قورت بدی!", "تمرین ۱: اگر عدد مثبت بود چاپ کن.\nتمرین ۲: اگر سن >= ۱۰ بود پیام بده.\nتمرین ۳: اگر عدد زوج بود چاپ کن.\n\nنکته: همیشه حالت‌های مختلف رو تست کن.", "if-practice"),
            ("چطور یک پروژه کوچک بسازیم؟", "پروژه‌های کوچک بهترین راه یادگیری هستند.", "به جای پروژه بزرگ، پروژه رو خرد کن:\n۱) خروجی نهایی\n۲) داده‌های لازم\n۳) مرحله‌های کوچک\n۴) تست هر مرحله\n\nبا همین روش به راحتی پروژه می‌سازی.", "small-projects"),
            ("چگونه تمرین روزانه را تبدیل به عادت کنیم؟", "یک تکنیک ساده برای اینکه ترک نکنی.", "قانون ۲ دقیقه: فقط ۲ دقیقه شروع کن.\n\nوقتی شروع کردی، ادامه دادن آسون می‌شه.\n\nهر روز یک درس یا یک بازی کافی است.", "daily-habit"),
            ("راهنمای انتخاب دوره: مقدماتی یا پیشرفته؟", "کی باید بری سراغ پیشرفته؟", "اگر می‌تونی با print، متغیر، if، for و لیست راحت کار کنی، آماده‌ای.\n\nاگر نه، هنوز مقدماتی رو ادامه بده و بازی‌ها رو بیشتر حل کن.", "choose-course"),
            ("چطور برای آزمون‌ها آماده بشیم؟", "روش تمرین با سوالات کوتاه.", "هر روز ۵ سوال کوچک بهتر از هفته‌ای یک بار ۵۰ سواله.\n\nخروجی دقیق رو تمرین کن و کد تمیز بنویس.", "exam-prep"),
            ("چطور سرعت تایپ کد رو بالا ببریم؟", "تکنیک‌های ساده", "با تمرین کوتاه و تکرار الگوها.\n\n۱) هر روز ۵ دقیقه تایپ کد\n۲) از روی مثال‌ها دوباره بنویس\n۳) اشتباه‌ها رو اصلاح کن", "typing-speed"),
            ("چرا دیدن ویدیو کافی نیست؟", "بدون تمرین، یادگیری کامل نمی‌شه.", "ویدیو برای فهم خوبه، اما یادگیری واقعی با تمرین اتفاق می‌افته.\n\nبعد از هر ویدیو، یک تمرین یا بازی انجام بده.", "video-not-enough"),
            ("راهنمای والدین: چطور کمک کنیم؟", "کمک درست یعنی انگیزه دادن، نه حل کردن.", "به جای حل کردن مسئله، سوال بپرسید:\n«خروجی چی باید باشه؟»\n«الان چی چاپ می‌شه؟»\n«کجا اشتباهه؟»\n\nاین کمک واقعی است.", "parents-guide"),
            ("آشنایی با Django برای نوجوان‌ها", "چرا وب‌سایت ساختن جذابه؟", "Django کمک می‌کنه با پایتون سایت بسازی.\n\nوقتی سایتت بالا میاد، انگیزه‌ات چند برابر می‌شه چون نتیجه رو می‌بینی.", "django-for-teens"),
            ("۳ پروژه Django ساده برای شروع", "پروژه‌هایی که سریع نتیجه می‌دهند.", "۱) صفحه معرفی\n۲) بلاگ کوچک\n۳) لیست کارها\n\nهر پروژه رو مرحله‌ای بساز.", "django-3-projects"),
            ("چطور رتبه گوگل بهتر می‌شه؟ (ساده)", "سئو با زبان ساده برای سازنده سایت آموزشی.", "محتوای خوب + استمرار + لینک داخلی + عنوان درست.\n\nهر دوره و هر مقاله یک صفحه اختصاصی می‌خواد.\n\nبا ۲۰ مقاله خوب، پایه سئو ساخته می‌شه.", "seo-simple"),
            ("چطور یک مسابقه سالم بسازیم؟", "رقابت بدون استرس", "هدف لیدربورد انگیزه است.\n\nرتبه رو با تمرین بالا ببر، نه با تقلب.\n\nقانون: هر روز کمی بهتر از دیروز.", "healthy-competition"),
            ("چطور با پایتون بازی بسازیم؟", "شروع ساده با منطق", "اول منطق بازی رو بساز: امتیاز، سطح، شرط برد.\n\nبعد می‌تونی سراغ گرافیک هم بری.\n\nفعلاً با متن هم می‌شه بازی ساخت!", "python-games"),
        ]
        for title, excerpt, content, slug in posts_data:
            Post.objects.get_or_create(
                slug=slug,
                defaults={
                    "title": title,
                    "excerpt": excerpt,
                    "content": content,
                    "author": author,
                    "is_published": True,
                    "published_at": now,
                },
            )

        self.stdout.write(self.style.SUCCESS("Seed content created/updated successfully."))

