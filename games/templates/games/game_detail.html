{% extends 'base.html' %}

{% block title %}{{ game.title }} - PY-Academy{% endblock %}

{% block content %}
    <!-- CSRF token Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØ°Ø§Ø±ÛŒÙ… ØªØ§ JavaScript Ø¨ØªÙˆÙ†Ù‡ Ø§Ø²Ø´ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ù‡ -->
    {% csrf_token %}

    <div class="max-w-5xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
        <!-- Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª -->
        <a href="{% url 'game_list' %}" class="text-indigo-400 hover:text-indigo-300 mb-6 inline-block text-lg font-medium">
            â† Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§
        </a>

        <h1 class="text-4xl md:text-5xl font-bold text-white mb-8 text-center">
            {{ game.title }}
        </h1>

        <p class="text-xl text-gray-300 mb-10 text-center">
            {{ game.description }}
        </p>

        <div class="bg-gray-900/70 backdrop-blur-xl p-8 rounded-3xl border border-gray-700 shadow-2xl">
            <h2 class="text-3xl font-bold text-blue-400 mb-6">
                Ú©Ø¯ Ø¨Ø§Ø²ÛŒ Ø±Ùˆ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡ Ùˆ Ø±Ø§Ù† Ú©Ù†
            </h2>

            <!-- Ø§Ø¯ÛŒØªÙˆØ± Ú©Ø¯ -->
            <textarea id="codeEditor" class="w-full h-64 p-4 bg-gray-800 border border-gray-700 text-white font-mono text-sm rounded-lg resize-y">
{{ game.code_template|default:"print('Ø³Ù„Ø§Ù…! Ú©Ø¯ Ø®ÙˆØ¯Øª Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³')" }}
            </textarea>

            <div class="mt-6 text-center">
                <button onclick="runCode()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-12 rounded-full text-xl shadow-2xl transform hover:scale-105 transition-all duration-300">
                    Ø±Ø§Ù† Ú©Ù† Ùˆ Ù†ØªÛŒØ¬Ù‡ Ø±Ùˆ Ø¨Ø¨ÛŒÙ†
                </button>
            </div>

            <!-- Ø®Ø±ÙˆØ¬ÛŒ -->
            <div id="output" class="mt-8 p-8 bg-black rounded-3xl border border-gray-700 min-h-[200px] text-white font-mono whitespace-pre-wrap">
                Ù†ØªÛŒØ¬Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´Ù‡...
            </div>
        </div>

        <p class="text-center text-indigo-400 mt-8 text-xl font-bold">
            Ø¬Ø§ÛŒØ²Ù‡ Ø§ÛŒÙ† Ø¨Ø§Ø²ÛŒ: {{ game.xp_reward }} XP
        </p>
    </div>

    <!-- Ø§Ø³Ú©Ø±ÛŒÙ¾Øª AJAX Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù† Ú©Ø¯ -->
    <script>
        function runCode() {
            const code = document.getElementById('codeEditor').value;
            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù† Ú©Ø±Ø¯Ù† Ú©Ø¯...';

            // CSRF token Ø±Ùˆ Ø§Ø² input Ù…Ø®ÙÛŒ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch("{% url 'run_game_code' game.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken  // Ø§ÛŒÙ† Ù…Ù‡Ù…Ù‡!
                },
                body: 'code=' + encodeURIComponent(code)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    outputDiv.innerHTML = '<pre>' + data.output + '</pre>' +
                        '<p class="text-green-400 mt-4">Ú©Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±Ø§Ù† Ø´Ø¯! +' + {{ game.xp_reward }} + ' XP Ú¯Ø±ÙØªÛŒ ğŸ‰</p>';
                } else {
                    outputDiv.innerHTML = '<pre class="text-red-400">' + data.output + '</pre>' +
                        '<p class="text-red-400 mt-4">Ø§Ø±ÙˆØ±! Ú©Ø¯ Ø±Ùˆ Ú†Ú© Ú©Ù†.</p>';
                }
            })
            .catch(error => {
                outputDiv.innerHTML = '<p class="text-red-400">Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ' + error + '</p>';
            });
        }
    </script>
{% endblock %}